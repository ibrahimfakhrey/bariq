{% extends "admin/layout.html" %}

{% block title %}Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª{% endblock %}

{% block page_content %}
<div id="audit-content">
    <div class="loading-container"><div class="spinner"></div></div>
</div>

<style>
.form-control { width: 100%; padding: 0.5rem 0.75rem; border: 1px solid var(--gray-300); border-radius: 0.375rem; font-size: 0.875rem; }
.log-details { background: var(--gray-50); padding: 0.75rem; border-radius: 0.5rem; font-family: monospace; font-size: 0.75rem; max-height: 100px; overflow-y: auto; white-space: pre-wrap; word-break: break-all; }
</style>
{% endblock %}

{% block extra_js %}
{{ super() }}
<script>
    let currentLogs = [];
    let currentPage = 1;
    let currentFilters = {};

    async function loadAuditLogs(page = 1, filters = {}) {
        const container = document.getElementById('audit-content');
        currentPage = page;
        currentFilters = filters;

        try {
            const params = { page, per_page: 50, ...filters };
            const result = await API.admin.getAuditLogs(params);

            if (!result.success) {
                showError(container, 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„');
                return;
            }

            currentLogs = result.data?.data?.logs || [];
            const pagination = result.data?.data?.pagination || {};

            container.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <div>
                        <h1 style="font-size: 1.5rem; font-weight: 700; color: var(--gray-900); margin-bottom: 0.25rem;">Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h1>
                        <p style="color: var(--gray-500);">Ø§Ø¬Ù…Ø§Ù„ÙŠ ${pagination.total || currentLogs.length} Ø³Ø¬Ù„</p>
                    </div>
                    <button onclick="exportLogs()" class="btn btn-secondary">ğŸ“¥ ØªØµØ¯ÙŠØ±</button>
                </div>

                <div class="card" style="margin-bottom: 1.5rem;">
                    <div style="display: flex; flex-wrap: wrap; gap: 1rem; align-items: flex-end;">
                        <div style="min-width: 150px;">
                            <label style="display: block; margin-bottom: 0.5rem; font-size: 0.875rem; color: var(--gray-600);">Ù†ÙˆØ¹ Ø§Ù„ÙØ§Ø¹Ù„</label>
                            <select id="actorTypeFilter" class="form-control" onchange="applyFilters()">
                                <option value="">Ø§Ù„ÙƒÙ„</option>
                                <option value="admin" ${filters.actor_type === 'admin' ? 'selected' : ''}>Ù…Ø¯ÙŠØ±</option>
                                <option value="system" ${filters.actor_type === 'system' ? 'selected' : ''}>Ø§Ù„Ù†Ø¸Ø§Ù…</option>
                                <option value="customer" ${filters.actor_type === 'customer' ? 'selected' : ''}>Ø¹Ù…ÙŠÙ„</option>
                                <option value="merchant" ${filters.actor_type === 'merchant' ? 'selected' : ''}>ØªØ§Ø¬Ø±</option>
                            </select>
                        </div>
                        <div style="min-width: 150px;">
                            <label style="display: block; margin-bottom: 0.5rem; font-size: 0.875rem; color: var(--gray-600);">Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</label>
                            <select id="actionFilter" class="form-control" onchange="applyFilters()">
                                <option value="">Ø§Ù„ÙƒÙ„</option>
                                <option value="create" ${filters.action === 'create' ? 'selected' : ''}>Ø§Ù†Ø´Ø§Ø¡</option>
                                <option value="update" ${filters.action === 'update' ? 'selected' : ''}>ØªØ¹Ø¯ÙŠÙ„</option>
                                <option value="delete" ${filters.action === 'delete' ? 'selected' : ''}>Ø­Ø°Ù</option>
                                <option value="login" ${filters.action === 'login' ? 'selected' : ''}>Ø¯Ø®ÙˆÙ„</option>
                                <option value="logout" ${filters.action === 'logout' ? 'selected' : ''}>Ø®Ø±ÙˆØ¬</option>
                                <option value="approve" ${filters.action === 'approve' ? 'selected' : ''}>Ù…ÙˆØ§ÙÙ‚Ø©</option>
                                <option value="reject" ${filters.action === 'reject' ? 'selected' : ''}>Ø±ÙØ¶</option>
                                <option value="suspend" ${filters.action === 'suspend' ? 'selected' : ''}>ØªØ¹Ù„ÙŠÙ‚</option>
                            </select>
                        </div>
                        <div style="min-width: 150px;">
                            <label style="display: block; margin-bottom: 0.5rem; font-size: 0.875rem; color: var(--gray-600);">Ù†ÙˆØ¹ Ø§Ù„ÙƒÙŠØ§Ù†</label>
                            <select id="entityTypeFilter" class="form-control" onchange="applyFilters()">
                                <option value="">Ø§Ù„ÙƒÙ„</option>
                                <option value="customer" ${filters.entity_type === 'customer' ? 'selected' : ''}>Ø¹Ù…ÙŠÙ„</option>
                                <option value="merchant" ${filters.entity_type === 'merchant' ? 'selected' : ''}>ØªØ§Ø¬Ø±</option>
                                <option value="transaction" ${filters.entity_type === 'transaction' ? 'selected' : ''}>Ù…Ø¹Ø§Ù…Ù„Ø©</option>
                                <option value="payment" ${filters.entity_type === 'payment' ? 'selected' : ''}>Ø¯ÙØ¹Ø©</option>
                                <option value="settlement" ${filters.entity_type === 'settlement' ? 'selected' : ''}>ØªØ³ÙˆÙŠØ©</option>
                                <option value="admin" ${filters.entity_type === 'admin' ? 'selected' : ''}>Ù…ÙˆØ¸Ù</option>
                            </select>
                        </div>
                        <div style="min-width: 150px;">
                            <label style="display: block; margin-bottom: 0.5rem; font-size: 0.875rem; color: var(--gray-600);">Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
                            <input type="date" id="fromDate" class="form-control" value="${filters.from_date || ''}">
                        </div>
                        <div style="min-width: 150px;">
                            <label style="display: block; margin-bottom: 0.5rem; font-size: 0.875rem; color: var(--gray-600);">Ø§Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
                            <input type="date" id="toDate" class="form-control" value="${filters.to_date || ''}">
                        </div>
                        <button onclick="applyFilters()" class="btn btn-primary">Ø¨Ø­Ø«</button>
                        <button onclick="clearFilters()" class="btn btn-secondary">Ù…Ø³Ø­</button>
                    </div>
                </div>

                <div class="card">
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                    <th>Ø§Ù„ÙØ§Ø¹Ù„</th>
                                    <th>Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th>
                                    <th>Ø§Ù„ÙƒÙŠØ§Ù†</th>
                                    <th>Ø§Ù„ØªÙØ§ØµÙŠÙ„</th>
                                    <th>IP</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${currentLogs.map(log => `
                                    <tr>
                                        <td style="white-space: nowrap;">${formatDateTime(log.created_at)}</td>
                                        <td>
                                            <div style="font-weight: 500;">${log.actor_name || log.actor_id || 'Ø§Ù„Ù†Ø¸Ø§Ù…'}</div>
                                            <div style="font-size: 0.75rem; color: var(--gray-500);">${getActorTypeLabel(log.actor_type)}</div>
                                        </td>
                                        <td><span class="badge ${getActionBadgeClass(log.action)}">${getActionLabel(log.action)}</span></td>
                                        <td>
                                            <div>${getEntityTypeLabel(log.entity_type)}</div>
                                            <div style="font-size: 0.75rem; font-family: monospace; color: var(--gray-500);">${log.entity_id || '-'}</div>
                                        </td>
                                        <td style="max-width: 300px;">
                                            ${log.details ? `
                                                <div class="log-details">${typeof log.details === 'object' ? JSON.stringify(log.details, null, 2) : log.details}</div>
                                            ` : '-'}
                                        </td>
                                        <td style="font-family: monospace; font-size: 0.75rem;">${log.ip_address || '-'}</td>
                                    </tr>
                                `).join('')}
                                ${currentLogs.length === 0 ? '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: var(--gray-500);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª</td></tr>' : ''}
                            </tbody>
                        </table>
                    </div>
                    ${pagination.pages > 1 ? `
                        <div style="display: flex; justify-content: center; gap: 0.5rem; padding: 1rem; border-top: 1px solid var(--gray-200);">
                            ${currentPage > 1 ? `<button onclick="loadAuditLogs(${currentPage - 1}, currentFilters)" class="btn btn-sm btn-secondary">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>` : ''}
                            <span style="padding: 0.5rem 1rem; color: var(--gray-600);">ØµÙØ­Ø© ${currentPage} Ù…Ù† ${pagination.pages}</span>
                            ${currentPage < pagination.pages ? `<button onclick="loadAuditLogs(${currentPage + 1}, currentFilters)" class="btn btn-sm btn-secondary">Ø§Ù„ØªØ§Ù„ÙŠ</button>` : ''}
                        </div>
                    ` : ''}
                </div>
            `;
        } catch (error) {
            showError(container, 'Ø­Ø¯Ø« Ø®Ø·Ø£');
        }
    }

    function applyFilters() {
        const filters = {
            actor_type: document.getElementById('actorTypeFilter')?.value || '',
            action: document.getElementById('actionFilter')?.value || '',
            entity_type: document.getElementById('entityTypeFilter')?.value || '',
            from_date: document.getElementById('fromDate')?.value || '',
            to_date: document.getElementById('toDate')?.value || ''
        };
        Object.keys(filters).forEach(k => !filters[k] && delete filters[k]);
        loadAuditLogs(1, filters);
    }

    function clearFilters() { loadAuditLogs(1, {}); }

    function getActorTypeLabel(type) {
        const labels = { 'admin': 'Ù…Ø¯ÙŠØ±', 'system': 'Ø§Ù„Ù†Ø¸Ø§Ù…', 'customer': 'Ø¹Ù…ÙŠÙ„', 'merchant': 'ØªØ§Ø¬Ø±' };
        return labels[type] || type || '-';
    }

    function getActionLabel(action) {
        const labels = {
            'create': 'Ø§Ù†Ø´Ø§Ø¡', 'update': 'ØªØ¹Ø¯ÙŠÙ„', 'delete': 'Ø­Ø°Ù',
            'login': 'Ø¯Ø®ÙˆÙ„', 'logout': 'Ø®Ø±ÙˆØ¬',
            'approve': 'Ù…ÙˆØ§ÙÙ‚Ø©', 'reject': 'Ø±ÙØ¶', 'suspend': 'ØªØ¹Ù„ÙŠÙ‚',
            'activate': 'ØªÙØ¹ÙŠÙ„', 'refund': 'Ø§Ø³ØªØ±Ø¯Ø§Ø¯', 'transfer': 'ØªØ­ÙˆÙŠÙ„',
            'adjust_credit': 'ØªØ¹Ø¯ÙŠÙ„ Ø±ØµÙŠØ¯', 'update_credit_limit': 'ØªØ¹Ø¯ÙŠÙ„ Ø­Ø¯ Ø§Ù„Ø§Ø¦ØªÙ…Ø§Ù†',
            'test_action': 'Ø§Ø®ØªØ¨Ø§Ø±'
        };
        return labels[action] || action || '-';
    }

    function getActionBadgeClass(action) {
        const classes = {
            'create': 'badge-success', 'update': 'badge-info', 'delete': 'badge-danger',
            'login': 'badge-gray', 'logout': 'badge-gray',
            'approve': 'badge-success', 'reject': 'badge-danger', 'suspend': 'badge-warning',
            'activate': 'badge-success', 'refund': 'badge-warning', 'transfer': 'badge-info',
            'adjust_credit': 'badge-info', 'update_credit_limit': 'badge-info',
            'test_action': 'badge-gray'
        };
        return classes[action] || 'badge-gray';
    }

    function getEntityTypeLabel(type) {
        const labels = {
            'customer': 'Ø¹Ù…ÙŠÙ„', 'merchant': 'ØªØ§Ø¬Ø±', 'transaction': 'Ù…Ø¹Ø§Ù…Ù„Ø©',
            'payment': 'Ø¯ÙØ¹Ø©', 'settlement': 'ØªØ³ÙˆÙŠØ©', 'admin': 'Ù…ÙˆØ¸Ù',
            'credit_request': 'Ø·Ù„Ø¨ Ø§Ø¦ØªÙ…Ø§Ù†', 'branch': 'ÙØ±Ø¹', 'staff': 'Ù…ÙˆØ¸Ù ØªØ§Ø¬Ø±'
        };
        return labels[type] || type || '-';
    }

    function exportLogs() {
        if (currentLogs.length === 0) { alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª'); return; }
        const data = currentLogs.map(log => ({
            'Ø§Ù„ØªØ§Ø±ÙŠØ®': log.created_at,
            'Ø§Ù„ÙØ§Ø¹Ù„': log.actor_name || log.actor_id,
            'Ù†ÙˆØ¹ Ø§Ù„ÙØ§Ø¹Ù„': getActorTypeLabel(log.actor_type),
            'Ø§Ù„Ø¹Ù…Ù„ÙŠØ©': getActionLabel(log.action),
            'Ø§Ù„ÙƒÙŠØ§Ù†': getEntityTypeLabel(log.entity_type),
            'Ù…Ø¹Ø±Ù Ø§Ù„ÙƒÙŠØ§Ù†': log.entity_id,
            'IP': log.ip_address,
            'Ø§Ù„ØªÙØ§ØµÙŠÙ„': typeof log.details === 'object' ? JSON.stringify(log.details) : log.details
        }));
        exportToExcel(data, 'audit-logs');
    }

    document.addEventListener('DOMContentLoaded', () => loadAuditLogs());
</script>
{% endblock %}
