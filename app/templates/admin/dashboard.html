{% extends "admin/layout.html" %}

{% block title %}Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ø§Ù„Ø§Ø¯Ø§Ø±Ø©{% endblock %}

{% block page_content %}
<div id="dashboard-content">
    <div class="loading-container">
        <div class="spinner"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ super() }}
<script>
    // Chart instances
    let transactionChart = null;
    let paymentMethodChart = null;
    let revenueChart = null;

    async function loadDashboard() {
        const container = document.getElementById('dashboard-content');

        try {
            // Load dashboard data
            const [dashboardResult, customersResult, merchantsResult, transactionsResult, paymentsResult, settlementsResult] = await Promise.all([
                API.admin.getDashboard(),
                API.admin.getCustomers({ per_page: 5 }),
                API.admin.getMerchants({ per_page: 5 }),
                API.admin.getTransactions({ per_page: 10 }),
                API.admin.getPayments({ per_page: 10 }),
                API.admin.getSettlements({ status: 'pending' })
            ]);

            // Extract data with fallbacks
            const stats = dashboardResult.data?.data || {};
            const customers = customersResult.data?.data?.customers || [];
            const merchants = merchantsResult.data?.data?.merchants || [];
            const transactions = transactionsResult.data?.data?.transactions || [];
            const payments = paymentsResult.data?.data?.payments || [];
            const pendingSettlements = settlementsResult.data?.data?.settlements || [];

            // Calculate stats from available data
            const totalCustomers = customersResult.data?.data?.pagination?.total || customers.length;
            const totalMerchants = merchantsResult.data?.data?.pagination?.total || merchants.length;
            const totalTransactions = transactionsResult.data?.data?.pagination?.total || transactions.length;
            const pendingSettlementsCount = pendingSettlements.length;

            // Calculate totals
            const totalRevenue = transactions.reduce((sum, t) => sum + parseFloat(t.total_amount || 0), 0);
            const overdueTransactions = transactions.filter(t => t.status === 'overdue');
            const overdueAmount = overdueTransactions.reduce((sum, t) => sum + parseFloat(t.remaining_amount || 0), 0);

            container.innerHTML = `
                <!-- Page Header -->
                <div style="margin-bottom: 2rem;">
                    <h1 style="font-size: 1.5rem; font-weight: 700; color: var(--gray-900); margin-bottom: 0.5rem;">
                        Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
                    </h1>
                    <p style="color: var(--gray-500);">Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø¸Ø§Ù…</p>
                </div>

                <!-- KPI Cards -->
                <div class="grid-4" style="margin-bottom: 2rem;">
                    <div class="stat-card stat-card-teal">
                        <div class="stat-icon">ğŸ’°</div>
                        <div class="stat-label">Ø§Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§ÙŠØ±Ø§Ø¯Ø§Øª</div>
                        <div class="stat-value">${formatCurrency(totalRevenue)}</div>
                    </div>
                    <div class="stat-card stat-card-emerald">
                        <div class="stat-icon">ğŸ‘¥</div>
                        <div class="stat-label">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div>
                        <div class="stat-value">${totalCustomers}</div>
                    </div>
                    <div class="stat-card stat-card-sky">
                        <div class="stat-icon">ğŸª</div>
                        <div class="stat-label">Ø§Ù„ØªØ¬Ø§Ø±</div>
                        <div class="stat-value">${totalMerchants}</div>
                    </div>
                    <div class="stat-card stat-card-amber">
                        <div class="stat-icon">â³</div>
                        <div class="stat-label">ØªØ³ÙˆÙŠØ§Øª Ù…Ø¹Ù„Ù‚Ø©</div>
                        <div class="stat-value">${pendingSettlementsCount}</div>
                    </div>
                </div>

                <!-- Alert Cards -->
                ${overdueTransactions.length > 0 ? `
                <div class="card" style="background: linear-gradient(135deg, var(--rose-50), var(--rose-100)); border-color: var(--rose-200); margin-bottom: 1.5rem;">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div style="font-size: 2rem;">âš ï¸</div>
                        <div>
                            <div style="font-weight: 600; color: var(--rose-700);">Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ù…ØªØ£Ø®Ø±Ø©</div>
                            <div style="color: var(--rose-600);">
                                ${overdueTransactions.length} Ù…Ø¹Ø§Ù…Ù„Ø© Ù…ØªØ£Ø®Ø±Ø© Ø¨Ù‚ÙŠÙ…Ø© ${formatCurrency(overdueAmount)}
                            </div>
                        </div>
                        <a href="/admin/transactions?status=overdue" class="btn btn-sm" style="margin-right: auto; background: var(--rose-600); color: white;">
                            Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„
                        </a>
                    </div>
                </div>
                ` : ''}

                <!-- Charts Section -->
                <div class="grid-2" style="margin-bottom: 2rem;">
                    <div class="card">
                        <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 1rem;">Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª (Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…)</h3>
                        <div style="height: 250px; position: relative;">
                            <canvas id="transactionChart"></canvas>
                        </div>
                    </div>
                    <div class="card">
                        <h3 style="font-size: 1rem; font-weight: 600; margin-bottom: 1rem;">Ø·Ø±Ù‚ Ø§Ù„Ø¯ÙØ¹</h3>
                        <div style="height: 250px; position: relative;">
                            <canvas id="paymentMethodChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="grid-4" style="margin-bottom: 2rem;">
                    <div class="card" style="text-align: center;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">ğŸ“‹</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--gray-900);">${totalTransactions}</div>
                        <div style="color: var(--gray-500); font-size: 0.875rem;">Ø§Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª</div>
                    </div>
                    <div class="card" style="text-align: center;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">âœ…</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--emerald-600);">${transactions.filter(t => t.status === 'paid').length}</div>
                        <div style="color: var(--gray-500); font-size: 0.875rem;">Ù…Ø¯ÙÙˆØ¹Ø©</div>
                    </div>
                    <div class="card" style="text-align: center;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">â³</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--amber-600);">${transactions.filter(t => t.status === 'pending' || t.status === 'confirmed').length}</div>
                        <div style="color: var(--gray-500); font-size: 0.875rem;">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</div>
                    </div>
                    <div class="card" style="text-align: center;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">ğŸš¨</div>
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--rose-600);">${overdueTransactions.length}</div>
                        <div style="color: var(--gray-500); font-size: 0.875rem;">Ù…ØªØ£Ø®Ø±Ø©</div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="grid-2">
                    <!-- Recent Transactions -->
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 style="font-size: 1rem; font-weight: 600;">Ø£Ø­Ø¯Ø« Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª</h3>
                            <a href="/admin/transactions" style="color: var(--teal-600); font-size: 0.875rem;">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</a>
                        </div>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ</th>
                                        <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                                        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${transactions.slice(0, 5).map(t => `
                                        <tr>
                                            <td style="font-family: monospace;">${t.reference_number || '-'}</td>
                                            <td>${formatCurrency(t.total_amount)}</td>
                                            <td><span class="badge ${getStatusBadgeClass(t.status)}">${getStatusLabel(t.status)}</span></td>
                                        </tr>
                                    `).join('')}
                                    ${transactions.length === 0 ? '<tr><td colspan="3" style="text-align: center; color: var(--gray-500);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª</td></tr>' : ''}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Recent Payments -->
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 style="font-size: 1rem; font-weight: 600;">Ø£Ø­Ø¯Ø« Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª</h3>
                            <a href="/admin/payments" style="color: var(--teal-600); font-size: 0.875rem;">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</a>
                        </div>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ</th>
                                        <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                                        <th>Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${payments.slice(0, 5).map(p => `
                                        <tr>
                                            <td style="font-family: monospace;">${p.reference_number || '-'}</td>
                                            <td>${formatCurrency(p.amount)}</td>
                                            <td>${p.payment_method || '-'}</td>
                                        </tr>
                                    `).join('')}
                                    ${payments.length === 0 ? '<tr><td colspan="3" style="text-align: center; color: var(--gray-500);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¯ÙÙˆØ¹Ø§Øª</td></tr>' : ''}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Pending Settlements -->
                ${pendingSettlements.length > 0 ? `
                <div class="card" style="margin-top: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="font-size: 1rem; font-weight: 600;">ØªØ³ÙˆÙŠØ§Øª Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©</h3>
                        <a href="/admin/settlements" style="color: var(--teal-600); font-size: 0.875rem;">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</a>
                    </div>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ</th>
                                    <th>Ø§Ù„ØªØ§Ø¬Ø±</th>
                                    <th>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ØµØ§ÙÙŠ</th>
                                    <th>Ø§Ù„Ø§Ø¬Ø±Ø§Ø¡</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${pendingSettlements.slice(0, 5).map(s => `
                                    <tr>
                                        <td style="font-family: monospace;">${s.reference_number || '-'}</td>
                                        <td>${s.merchant?.name_ar || '-'}</td>
                                        <td>${formatCurrency(s.net_amount)}</td>
                                        <td>
                                            <button onclick="approveSettlement('${s.id}')" class="btn btn-sm btn-primary">
                                                Ù…ÙˆØ§ÙÙ‚Ø©
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
                ` : ''}
            `;

            // Initialize charts
            initCharts(transactions, payments);

        } catch (error) {
            console.error('Dashboard error:', error);
            showError(container, 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…');
        }
    }

    function initCharts(transactions, payments) {
        // Transaction Chart (Bar)
        const transactionCtx = document.getElementById('transactionChart');
        if (transactionCtx) {
            // Group transactions by day
            const last7Days = [];
            const today = new Date();
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                last7Days.push(date.toISOString().split('T')[0]);
            }

            const transactionsByDay = last7Days.map(day => {
                return transactions.filter(t => t.created_at && t.created_at.startsWith(day)).length;
            });

            transactionChart = new Chart(transactionCtx, {
                type: 'bar',
                data: {
                    labels: last7Days.map(d => {
                        const date = new Date(d);
                        return date.toLocaleDateString('ar-SA', { weekday: 'short' });
                    }),
                    datasets: [{
                        label: 'Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª',
                        data: transactionsByDay,
                        backgroundColor: 'rgba(20, 184, 166, 0.8)',
                        borderColor: 'rgba(20, 184, 166, 1)',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    }
                }
            });
        }

        // Payment Method Chart (Doughnut)
        const paymentCtx = document.getElementById('paymentMethodChart');
        if (paymentCtx) {
            const methodCounts = {};
            payments.forEach(p => {
                const method = p.payment_method || 'other';
                methodCounts[method] = (methodCounts[method] || 0) + 1;
            });

            const methodLabels = {
                'creditcard': 'Ø¨Ø·Ø§Ù‚Ø© Ø§Ø¦ØªÙ…Ø§Ù†',
                'mada': 'Ù…Ø¯Ù‰',
                'applepay': 'Apple Pay',
                'stcpay': 'STC Pay',
                'cash': 'Ù†Ù‚Ø¯ÙŠ',
                'bank_transfer': 'ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ',
                'paytabs': 'PayTabs',
                'other': 'Ø£Ø®Ø±Ù‰'
            };

            const colors = [
                'rgba(20, 184, 166, 0.8)',
                'rgba(16, 185, 129, 0.8)',
                'rgba(245, 158, 11, 0.8)',
                'rgba(239, 68, 68, 0.8)',
                'rgba(99, 102, 241, 0.8)',
                'rgba(236, 72, 153, 0.8)'
            ];

            paymentMethodChart = new Chart(paymentCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(methodCounts).map(k => methodLabels[k] || k),
                    datasets: [{
                        data: Object.values(methodCounts),
                        backgroundColor: colors.slice(0, Object.keys(methodCounts).length),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            rtl: true
                        }
                    }
                }
            });
        }
    }

    async function approveSettlement(id) {
        if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„ØªØ³ÙˆÙŠØ©ØŸ')) return;

        try {
            const result = await API.admin.approveSettlement(id);
            if (result.success) {
                alert('ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„ØªØ³ÙˆÙŠØ© Ø¨Ù†Ø¬Ø§Ø­');
                loadDashboard();
            } else {
                alert(result.data?.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£');
            }
        } catch (error) {
            alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„ØªØ³ÙˆÙŠØ©');
        }
    }

    // Load dashboard on page load
    document.addEventListener('DOMContentLoaded', loadDashboard);
</script>
{% endblock %}
