{% extends "admin/layout.html" %}

{% block title %}Ø§Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¬Ø§Ø±{% endblock %}

{% block page_content %}
<div id="merchants-content">
    <div class="loading-container">
        <div class="spinner"></div>
    </div>
</div>

<!-- Merchant Detail Modal -->
<div id="merchantModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <h3 id="modalTitle">ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ§Ø¬Ø±</h3>
            <button onclick="closeModal()" class="btn btn-sm btn-secondary">&times;</button>
        </div>
        <div id="modalBody" class="modal-body"></div>
    </div>
</div>

<style>
.modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; }
.modal-content { background: white; border-radius: 0.75rem; width: 90%; max-height: 90vh; overflow-y: auto; }
.modal-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.5rem; border-bottom: 1px solid var(--gray-200); }
.modal-header h3 { margin: 0; font-size: 1.125rem; }
.modal-body { padding: 1.5rem; }
.form-group { margin-bottom: 1rem; }
.form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--gray-700); }
.form-control { width: 100%; padding: 0.5rem 0.75rem; border: 1px solid var(--gray-300); border-radius: 0.375rem; font-size: 0.875rem; }
</style>
{% endblock %}

{% block extra_js %}
{{ super() }}
<script>
    let currentMerchants = [];
    let currentPage = 1;
    let currentFilters = {};

    async function loadMerchants(page = 1, filters = {}) {
        const container = document.getElementById('merchants-content');
        currentPage = page;
        currentFilters = filters;

        try {
            const params = { page, per_page: 20, ...filters };
            const result = await API.admin.getMerchants(params);

            if (!result.success) {
                showError(container, 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ¬Ø§Ø±');
                return;
            }

            currentMerchants = result.data?.data?.merchants || [];
            const pagination = result.data?.data?.pagination || {};

            container.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <div>
                        <h1 style="font-size: 1.5rem; font-weight: 700; color: var(--gray-900); margin-bottom: 0.25rem;">Ø§Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¬Ø§Ø±</h1>
                        <p style="color: var(--gray-500);">Ø§Ø¬Ù…Ø§Ù„ÙŠ ${pagination.total || 0} ØªØ§Ø¬Ø±</p>
                    </div>
                    <button onclick="exportMerchants()" class="btn btn-secondary">ğŸ“¥ ØªØµØ¯ÙŠØ± Excel</button>
                </div>

                <div class="card" style="margin-bottom: 1.5rem;">
                    <div style="display: flex; flex-wrap: wrap; gap: 1rem; align-items: flex-end;">
                        <div style="flex: 1; min-width: 200px;">
                            <label style="display: block; margin-bottom: 0.5rem; font-size: 0.875rem; color: var(--gray-600);">Ø¨Ø­Ø«</label>
                            <input type="text" id="searchInput" placeholder="Ø§Ø³Ù… Ø§Ù„ØªØ§Ø¬Ø±ØŒ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ..." class="form-control" value="${filters.search || ''}" onkeyup="if(event.key === 'Enter') applyFilters()">
                        </div>
                        <div style="min-width: 150px;">
                            <label style="display: block; margin-bottom: 0.5rem; font-size: 0.875rem; color: var(--gray-600);">Ø§Ù„Ø­Ø§Ù„Ø©</label>
                            <select id="statusFilter" class="form-control" onchange="applyFilters()">
                                <option value="">Ø§Ù„ÙƒÙ„</option>
                                <option value="active" ${filters.status === 'active' ? 'selected' : ''}>Ù†Ø´Ø·</option>
                                <option value="pending" ${filters.status === 'pending' ? 'selected' : ''}>Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©</option>
                                <option value="suspended" ${filters.status === 'suspended' ? 'selected' : ''}>Ù…ÙˆÙ‚ÙˆÙ</option>
                            </select>
                        </div>
                        <button onclick="applyFilters()" class="btn btn-primary">Ø¨Ø­Ø«</button>
                        <button onclick="clearFilters()" class="btn btn-secondary">Ù…Ø³Ø­</button>
                    </div>
                </div>

                <div class="card">
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Ø§Ù„Ø§Ø³Ù…</th>
                                    <th>Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ</th>
                                    <th>Ù†ÙˆØ¹ Ø§Ù„Ù†Ø´Ø§Ø·</th>
                                    <th>Ø§Ù„ÙØ±ÙˆØ¹</th>
                                    <th>Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©</th>
                                    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                    <th>Ø§Ù„Ø§Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${currentMerchants.map(m => `
                                    <tr>
                                        <td><strong>${m.name_ar || m.name_en || '-'}</strong></td>
                                        <td style="font-family: monospace;">${m.commercial_registration || '-'}</td>
                                        <td>${m.business_type || '-'}</td>
                                        <td>${m.branches_count || 0}</td>
                                        <td>${m.commission_rate || 2.5}%</td>
                                        <td><span class="badge ${getStatusBadgeClass(m.status)}">${getStatusLabel(m.status)}</span></td>
                                        <td>
                                            <div style="display: flex; gap: 0.5rem;">
                                                <button onclick="viewMerchant('${m.id}')" class="btn btn-sm btn-secondary" title="Ø¹Ø±Ø¶">ğŸ‘ï¸</button>
                                                ${m.status === 'pending' ? `
                                                    <button onclick="approveMerchant('${m.id}')" class="btn btn-sm btn-primary" title="Ù…ÙˆØ§ÙÙ‚Ø©">âœ…</button>
                                                ` : m.status === 'active' ? `
                                                    <button onclick="suspendMerchant('${m.id}')" class="btn btn-sm" style="background: var(--amber-500); color: white;" title="Ø§ÙŠÙ‚Ø§Ù">â¸ï¸</button>
                                                ` : `
                                                    <button onclick="activateMerchant('${m.id}')" class="btn btn-sm" style="background: var(--emerald-500); color: white;" title="ØªÙØ¹ÙŠÙ„">â–¶ï¸</button>
                                                `}
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                                ${currentMerchants.length === 0 ? '<tr><td colspan="7" style="text-align: center; padding: 2rem; color: var(--gray-500);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</td></tr>' : ''}
                            </tbody>
                        </table>
                    </div>
                    ${pagination.pages > 1 ? `
                        <div style="display: flex; justify-content: center; gap: 0.5rem; padding: 1rem; border-top: 1px solid var(--gray-200);">
                            ${currentPage > 1 ? `<button onclick="loadMerchants(${currentPage - 1}, currentFilters)" class="btn btn-sm btn-secondary">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>` : ''}
                            <span style="padding: 0.5rem 1rem; color: var(--gray-600);">ØµÙØ­Ø© ${currentPage} Ù…Ù† ${pagination.pages}</span>
                            ${currentPage < pagination.pages ? `<button onclick="loadMerchants(${currentPage + 1}, currentFilters)" class="btn btn-sm btn-secondary">Ø§Ù„ØªØ§Ù„ÙŠ</button>` : ''}
                        </div>
                    ` : ''}
                </div>
            `;
        } catch (error) {
            showError(container, 'Ø­Ø¯Ø« Ø®Ø·Ø£');
        }
    }

    function applyFilters() {
        const filters = {
            search: document.getElementById('searchInput')?.value || '',
            status: document.getElementById('statusFilter')?.value || ''
        };
        Object.keys(filters).forEach(k => !filters[k] && delete filters[k]);
        loadMerchants(1, filters);
    }

    function clearFilters() { loadMerchants(1, {}); }

    async function viewMerchant(id) {
        const modal = document.getElementById('merchantModal');
        const modalBody = document.getElementById('modalBody');
        modal.style.display = 'flex';
        modalBody.innerHTML = '<div class="loading-container"><div class="spinner"></div></div>';

        try {
            const result = await API.admin.getMerchant(id);
            const m = result.data?.data || {};
            document.getElementById('modalTitle').textContent = m.name_ar || 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ§Ø¬Ø±';

            modalBody.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div><label style="color: var(--gray-500); font-size: 0.75rem;">Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ</label><div>${m.name_ar || '-'}</div></div>
                    <div><label style="color: var(--gray-500); font-size: 0.75rem;">Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠ</label><div>${m.name_en || '-'}</div></div>
                    <div><label style="color: var(--gray-500); font-size: 0.75rem;">Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ</label><div style="font-family: monospace;">${m.commercial_registration || '-'}</div></div>
                    <div><label style="color: var(--gray-500); font-size: 0.75rem;">Ù†ÙˆØ¹ Ø§Ù„Ù†Ø´Ø§Ø·</label><div>${m.business_type || '-'}</div></div>
                    <div><label style="color: var(--gray-500); font-size: 0.75rem;">Ø§Ù„Ø¨Ø±ÙŠØ¯</label><div>${m.email || '-'}</div></div>
                    <div><label style="color: var(--gray-500); font-size: 0.75rem;">Ø§Ù„Ù‡Ø§ØªÙ</label><div dir="ltr">${m.phone || '-'}</div></div>
                    <div><label style="color: var(--gray-500); font-size: 0.75rem;">Ù†Ø³Ø¨Ø© Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©</label><div>${m.commission_rate || 2.5}%</div></div>
                    <div><label style="color: var(--gray-500); font-size: 0.75rem;">Ø§Ù„Ø­Ø§Ù„Ø©</label><div><span class="badge ${getStatusBadgeClass(m.status)}">${getStatusLabel(m.status)}</span></div></div>
                </div>
                <hr style="margin: 1.5rem 0; border: none; border-top: 1px solid var(--gray-200);">
                <h4 style="margin-bottom: 1rem;">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ù†ÙƒÙŠØ©</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div><label style="color: var(--gray-500); font-size: 0.75rem;">Ø§Ù„Ø¨Ù†Ùƒ</label><div>${m.bank_name || '-'}</div></div>
                    <div><label style="color: var(--gray-500); font-size: 0.75rem;">IBAN</label><div style="font-family: monospace;">${m.iban || '-'}</div></div>
                </div>
                <div style="margin-top: 1.5rem; display: flex; gap: 1rem; justify-content: flex-end;">
                    <button onclick="closeModal()" class="btn btn-secondary">Ø§ØºÙ„Ø§Ù‚</button>
                </div>
            `;
        } catch (error) {
            modalBody.innerHTML = '<div class="alert alert-error">Ø­Ø¯Ø« Ø®Ø·Ø£</div>';
        }
    }

    function closeModal() { document.getElementById('merchantModal').style.display = 'none'; }

    async function approveMerchant(id) {
        const rate = prompt('Ø§Ø¯Ø®Ù„ Ù†Ø³Ø¨Ø© Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© (%):', '2.5');
        if (!rate) return;
        try {
            const result = await API.admin.approveMerchant(id, parseFloat(rate));
            if (result.success) { alert('ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©'); loadMerchants(currentPage, currentFilters); }
            else { alert(result.data?.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£'); }
        } catch (error) { alert('Ø­Ø¯Ø« Ø®Ø·Ø£'); }
    }

    async function suspendMerchant(id) {
        const reason = prompt('Ø³Ø¨Ø¨ Ø§Ù„Ø§ÙŠÙ‚Ø§Ù:');
        if (!reason) return;
        try {
            const result = await API.admin.suspendMerchant(id, reason);
            if (result.success) { alert('ØªÙ… Ø§Ù„Ø§ÙŠÙ‚Ø§Ù'); loadMerchants(currentPage, currentFilters); }
            else { alert(result.data?.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£'); }
        } catch (error) { alert('Ø­Ø¯Ø« Ø®Ø·Ø£'); }
    }

    async function activateMerchant(id) {
        if (!confirm('ØªÙØ¹ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„ØªØ§Ø¬Ø±ØŸ')) return;
        try {
            const result = await API.admin.updateMerchant(id, { status: 'active' });
            if (result.success) { alert('ØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„'); loadMerchants(currentPage, currentFilters); }
            else { alert(result.data?.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£'); }
        } catch (error) { alert('Ø­Ø¯Ø« Ø®Ø·Ø£'); }
    }

    function exportMerchants() {
        if (currentMerchants.length === 0) { alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª'); return; }
        const data = currentMerchants.map(m => ({
            'Ø§Ù„Ø§Ø³Ù…': m.name_ar, 'Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ': m.commercial_registration, 'Ù†ÙˆØ¹ Ø§Ù„Ù†Ø´Ø§Ø·': m.business_type,
            'Ø§Ù„Ø¨Ø±ÙŠØ¯': m.email, 'Ø§Ù„Ù‡Ø§ØªÙ': m.phone, 'Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©': m.commission_rate + '%', 'Ø§Ù„Ø­Ø§Ù„Ø©': getStatusLabel(m.status)
        }));
        exportToExcel(data, 'merchants');
    }

    document.addEventListener('DOMContentLoaded', () => loadMerchants());
</script>
{% endblock %}
