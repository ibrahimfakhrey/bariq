{% extends "admin/layout.html" %}

{% block title %}Ø§Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª{% endblock %}

{% block page_content %}
<div id="payments-content">
    <div class="loading-container"><div class="spinner"></div></div>
</div>

<!-- Payment Detail Modal -->
<div id="paymentModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <h3 id="modalTitle">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø©</h3>
            <button onclick="closeModal()" class="btn btn-sm btn-secondary">&times;</button>
        </div>
        <div id="modalBody" class="modal-body"></div>
    </div>
</div>

<!-- Refund Modal -->
<div id="refundModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h3>Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø¨Ù„Øº</h3>
            <button onclick="closeRefundModal()" class="btn btn-sm btn-secondary">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Ø±Ù‚Ù… Ø§Ù„Ø¯ÙØ¹Ø©</label>
                <input type="text" id="refundPaymentRef" class="form-control" readonly>
            </div>
            <div class="form-group">
                <label>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø£ØµÙ„ÙŠ</label>
                <input type="text" id="refundOriginalAmount" class="form-control" readonly>
            </div>
            <div class="form-group">
                <label>Ù…Ø¨Ù„Øº Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯ <span style="color: var(--rose-500);">*</span></label>
                <input type="number" id="refundAmount" class="form-control" step="0.01" min="0.01" required>
            </div>
            <div class="form-group">
                <label>Ø³Ø¨Ø¨ Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯ <span style="color: var(--rose-500);">*</span></label>
                <select id="refundReason" class="form-control" required>
                    <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø³Ø¨Ø¨ --</option>
                    <option value="customer_request">Ø·Ù„Ø¨ Ø§Ù„Ø¹Ù…ÙŠÙ„</option>
                    <option value="duplicate_payment">Ø¯ÙØ¹Ø© Ù…ÙƒØ±Ø±Ø©</option>
                    <option value="transaction_cancelled">Ø§Ù„ØºØ§Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©</option>
                    <option value="technical_error">Ø®Ø·Ø£ ØªÙ‚Ù†ÙŠ</option>
                    <option value="fraud">Ø§Ø­ØªÙŠØ§Ù„</option>
                    <option value="other">Ø£Ø®Ø±Ù‰</option>
                </select>
            </div>
            <div class="form-group">
                <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                <textarea id="refundNotes" class="form-control" rows="2"></textarea>
            </div>
            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                <button onclick="closeRefundModal()" class="btn btn-secondary">Ø§Ù„ØºØ§Ø¡</button>
                <button onclick="processRefund()" class="btn" style="background: var(--rose-600); color: white;">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯</button>
            </div>
        </div>
    </div>
</div>

<style>
.modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; }
.modal-content { background: white; border-radius: 0.75rem; width: 90%; max-height: 90vh; overflow-y: auto; }
.modal-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.5rem; border-bottom: 1px solid var(--gray-200); }
.modal-header h3 { margin: 0; font-size: 1.125rem; }
.modal-body { padding: 1.5rem; }
.form-group { margin-bottom: 1rem; }
.form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--gray-700); }
.form-control { width: 100%; padding: 0.5rem 0.75rem; border: 1px solid var(--gray-300); border-radius: 0.375rem; font-size: 0.875rem; }
</style>
{% endblock %}

{% block extra_js %}
{{ super() }}
<script>
    let currentPayments = [];
    let currentPage = 1;
    let currentFilters = {};
    let selectedPayment = null;

    async function loadPayments(page = 1, filters = {}) {
        const container = document.getElementById('payments-content');
        currentPage = page;
        currentFilters = filters;

        try {
            const params = { page, per_page: 20, ...filters };
            const result = await API.admin.getPayments(params);

            if (!result.success) {
                showError(container, 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª');
                return;
            }

            currentPayments = result.data?.data?.payments || [];
            const pagination = result.data?.data?.pagination || {};

            container.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <div>
                        <h1 style="font-size: 1.5rem; font-weight: 700; color: var(--gray-900); margin-bottom: 0.25rem;">Ø§Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª</h1>
                        <p style="color: var(--gray-500);">Ø§Ø¬Ù…Ø§Ù„ÙŠ ${pagination.total || 0} Ø¯ÙØ¹Ø©</p>
                    </div>
                    <button onclick="exportPayments()" class="btn btn-secondary">ğŸ“¥ ØªØµØ¯ÙŠØ± Excel</button>
                </div>

                <div class="card" style="margin-bottom: 1.5rem;">
                    <div style="display: flex; flex-wrap: wrap; gap: 1rem; align-items: flex-end;">
                        <div style="flex: 1; min-width: 200px;">
                            <label style="display: block; margin-bottom: 0.5rem; font-size: 0.875rem; color: var(--gray-600);">Ø¨Ø­Ø«</label>
                            <input type="text" id="searchInput" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¯ÙØ¹Ø©ØŒ Ø±Ù‚Ù… Ø¨Ø±ÙŠÙ‚..." class="form-control" value="${filters.search || ''}" onkeyup="if(event.key === 'Enter') applyFilters()">
                        </div>
                        <div style="min-width: 150px;">
                            <label style="display: block; margin-bottom: 0.5rem; font-size: 0.875rem; color: var(--gray-600);">Ø§Ù„Ø­Ø§Ù„Ø©</label>
                            <select id="statusFilter" class="form-control" onchange="applyFilters()">
                                <option value="">Ø§Ù„ÙƒÙ„</option>
                                <option value="pending" ${filters.status === 'pending' ? 'selected' : ''}>Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</option>
                                <option value="completed" ${filters.status === 'completed' ? 'selected' : ''}>Ù…ÙƒØªÙ…Ù„Ø©</option>
                                <option value="failed" ${filters.status === 'failed' ? 'selected' : ''}>ÙØ§Ø´Ù„Ø©</option>
                                <option value="refunded" ${filters.status === 'refunded' ? 'selected' : ''}>Ù…Ø³ØªØ±Ø¯Ø©</option>
                            </select>
                        </div>
                        <div style="min-width: 150px;">
                            <label style="display: block; margin-bottom: 0.5rem; font-size: 0.875rem; color: var(--gray-600);">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label>
                            <select id="methodFilter" class="form-control" onchange="applyFilters()">
                                <option value="">Ø§Ù„ÙƒÙ„</option>
                                <option value="creditcard" ${filters.payment_method === 'creditcard' ? 'selected' : ''}>Ø¨Ø·Ø§Ù‚Ø© Ø§Ø¦ØªÙ…Ø§Ù†</option>
                                <option value="mada" ${filters.payment_method === 'mada' ? 'selected' : ''}>Ù…Ø¯Ù‰</option>
                                <option value="applepay" ${filters.payment_method === 'applepay' ? 'selected' : ''}>Apple Pay</option>
                                <option value="stcpay" ${filters.payment_method === 'stcpay' ? 'selected' : ''}>STC Pay</option>
                            </select>
                        </div>
                        <div style="min-width: 150px;">
                            <label style="display: block; margin-bottom: 0.5rem; font-size: 0.875rem; color: var(--gray-600);">Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
                            <input type="date" id="fromDate" class="form-control" value="${filters.from_date || ''}">
                        </div>
                        <div style="min-width: 150px;">
                            <label style="display: block; margin-bottom: 0.5rem; font-size: 0.875rem; color: var(--gray-600);">Ø§Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
                            <input type="date" id="toDate" class="form-control" value="${filters.to_date || ''}">
                        </div>
                        <button onclick="applyFilters()" class="btn btn-primary">Ø¨Ø­Ø«</button>
                        <button onclick="clearFilters()" class="btn btn-secondary">Ù…Ø³Ø­</button>
                    </div>
                </div>

                <div class="card">
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹</th>
                                    <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                                    <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                                    <th>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</th>
                                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                    <th>Ø§Ù„Ø§Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${currentPayments.map(p => `
                                    <tr>
                                        <td style="font-family: monospace; font-weight: 600;">${p.reference_number || '-'}</td>
                                        <td>${p.customer?.full_name_ar || p.customer?.bariq_id || '-'}</td>
                                        <td>${formatCurrency(p.amount)}</td>
                                        <td>${getPaymentMethodLabel(p.payment_method)}</td>
                                        <td>${formatDateTime(p.created_at)}</td>
                                        <td><span class="badge ${getPaymentStatusBadgeClass(p.status)}">${getPaymentStatusLabel(p.status)}</span></td>
                                        <td>
                                            <div style="display: flex; gap: 0.5rem;">
                                                <button onclick="viewPayment('${p.id}')" class="btn btn-sm btn-secondary" title="Ø¹Ø±Ø¶">ğŸ‘ï¸</button>
                                                ${p.status === 'completed' ? `
                                                    <button onclick="openRefundModal('${p.id}')" class="btn btn-sm" style="background: var(--rose-500); color: white;" title="Ø§Ø³ØªØ±Ø¯Ø§Ø¯">â†©ï¸</button>
                                                ` : ''}
                                                ${p.gateway_reference ? `
                                                    <button onclick="queryGateway('${p.gateway_reference}')" class="btn btn-sm btn-secondary" title="Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø§Ù„Ø¨ÙˆØ§Ø¨Ø©">ğŸ”</button>
                                                ` : ''}
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                                ${currentPayments.length === 0 ? '<tr><td colspan="7" style="text-align: center; padding: 2rem; color: var(--gray-500);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</td></tr>' : ''}
                            </tbody>
                        </table>
                    </div>
                    ${pagination.pages > 1 ? `
                        <div style="display: flex; justify-content: center; gap: 0.5rem; padding: 1rem; border-top: 1px solid var(--gray-200);">
                            ${currentPage > 1 ? `<button onclick="loadPayments(${currentPage - 1}, currentFilters)" class="btn btn-sm btn-secondary">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>` : ''}
                            <span style="padding: 0.5rem 1rem; color: var(--gray-600);">ØµÙØ­Ø© ${currentPage} Ù…Ù† ${pagination.pages}</span>
                            ${currentPage < pagination.pages ? `<button onclick="loadPayments(${currentPage + 1}, currentFilters)" class="btn btn-sm btn-secondary">Ø§Ù„ØªØ§Ù„ÙŠ</button>` : ''}
                        </div>
                    ` : ''}
                </div>
            `;
        } catch (error) {
            showError(container, 'Ø­Ø¯Ø« Ø®Ø·Ø£');
        }
    }

    function applyFilters() {
        const filters = {
            search: document.getElementById('searchInput')?.value || '',
            status: document.getElementById('statusFilter')?.value || '',
            payment_method: document.getElementById('methodFilter')?.value || '',
            from_date: document.getElementById('fromDate')?.value || '',
            to_date: document.getElementById('toDate')?.value || ''
        };
        Object.keys(filters).forEach(k => !filters[k] && delete filters[k]);
        loadPayments(1, filters);
    }

    function clearFilters() { loadPayments(1, {}); }

    async function viewPayment(id) {
        const modal = document.getElementById('paymentModal');
        const modalBody = document.getElementById('modalBody');
        modal.style.display = 'flex';
        modalBody.innerHTML = '<div class="loading-container"><div class="spinner"></div></div>';

        try {
            const result = await API.admin.getPayment(id);
            const p = result.data?.data || {};
            document.getElementById('modalTitle').textContent = `Ø¯ÙØ¹Ø© #${p.reference_number || ''}`;

            modalBody.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div><label style="color: var(--gray-500); font-size: 0.75rem;">Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹</label><div style="font-family: monospace;">${p.reference_number || '-'}</div></div>
                    <div><label style="color: var(--gray-500); font-size: 0.75rem;">Ø§Ù„Ø­Ø§Ù„Ø©</label><div><span class="badge ${getPaymentStatusBadgeClass(p.status)}">${getPaymentStatusLabel(p.status)}</span></div></div>
                    <div><label style="color: var(--gray-500); font-size: 0.75rem;">Ø§Ù„Ù…Ø¨Ù„Øº</label><div style="font-weight: 600; color: var(--teal-600);">${formatCurrency(p.amount)}</div></div>
                    <div><label style="color: var(--gray-500); font-size: 0.75rem;">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label><div>${getPaymentMethodLabel(p.payment_method)}</div></div>
                    <div><label style="color: var(--gray-500); font-size: 0.75rem;">Ø§Ù„Ø¹Ù…ÙŠÙ„</label><div>${p.customer?.full_name_ar || '-'}</div></div>
                    <div><label style="color: var(--gray-500); font-size: 0.75rem;">Ø±Ù‚Ù… Ø¨Ø±ÙŠÙ‚</label><div style="font-family: monospace;">${p.customer?.bariq_id || '-'}</div></div>
                    <div><label style="color: var(--gray-500); font-size: 0.75rem;">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†Ø´Ø§Ø¡</label><div>${formatDateTime(p.created_at)}</div></div>
                    <div><label style="color: var(--gray-500); font-size: 0.75rem;">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§ÙƒØªÙ…Ø§Ù„</label><div>${formatDateTime(p.completed_at)}</div></div>
                </div>
                ${p.gateway_reference ? `
                    <hr style="margin: 1.5rem 0; border: none; border-top: 1px solid var(--gray-200);">
                    <h4 style="margin-bottom: 1rem;">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨ÙˆØ§Ø¨Ø©</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div><label style="color: var(--gray-500); font-size: 0.75rem;">Ù…Ø±Ø¬Ø¹ Ø§Ù„Ø¨ÙˆØ§Ø¨Ø©</label><div style="font-family: monospace;">${p.gateway_reference || '-'}</div></div>
                        <div><label style="color: var(--gray-500); font-size: 0.75rem;">Ø±Ø¯ Ø§Ù„Ø¨ÙˆØ§Ø¨Ø©</label><div>${p.gateway_response || '-'}</div></div>
                    </div>
                ` : ''}
                ${p.transaction ? `
                    <hr style="margin: 1.5rem 0; border: none; border-top: 1px solid var(--gray-200);">
                    <h4 style="margin-bottom: 1rem;">Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div><label style="color: var(--gray-500); font-size: 0.75rem;">Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©</label><div style="font-family: monospace;">${p.transaction.reference_number || '-'}</div></div>
                        <div><label style="color: var(--gray-500); font-size: 0.75rem;">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø§Ø¬Ù…Ø§Ù„ÙŠ</label><div>${formatCurrency(p.transaction.total_amount)}</div></div>
                    </div>
                ` : ''}
                <div style="margin-top: 1.5rem; display: flex; gap: 1rem; justify-content: flex-end;">
                    <button onclick="closeModal()" class="btn btn-secondary">Ø§ØºÙ„Ø§Ù‚</button>
                    ${p.status === 'completed' ? `<button onclick="closeModal(); openRefundModal('${p.id}')" class="btn" style="background: var(--rose-600); color: white;">Ø§Ø³ØªØ±Ø¯Ø§Ø¯</button>` : ''}
                </div>
            `;
        } catch (error) {
            modalBody.innerHTML = '<div class="alert alert-error">Ø­Ø¯Ø« Ø®Ø·Ø£</div>';
        }
    }

    function closeModal() { document.getElementById('paymentModal').style.display = 'none'; }

    function openRefundModal(paymentId) {
        selectedPayment = currentPayments.find(p => p.id === paymentId);
        if (!selectedPayment) return;

        document.getElementById('refundPaymentRef').value = selectedPayment.reference_number;
        document.getElementById('refundOriginalAmount').value = formatCurrency(selectedPayment.amount);
        document.getElementById('refundAmount').value = selectedPayment.amount;
        document.getElementById('refundAmount').max = selectedPayment.amount;
        document.getElementById('refundReason').value = '';
        document.getElementById('refundNotes').value = '';
        document.getElementById('refundModal').style.display = 'flex';
    }

    function closeRefundModal() {
        document.getElementById('refundModal').style.display = 'none';
        selectedPayment = null;
    }

    async function processRefund() {
        if (!selectedPayment) return;

        const amount = parseFloat(document.getElementById('refundAmount').value);
        const reason = document.getElementById('refundReason').value;
        const notes = document.getElementById('refundNotes').value;

        if (!amount || amount <= 0) { alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­'); return; }
        if (amount > selectedPayment.amount) { alert('Ù…Ø¨Ù„Øº Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠØªØ¬Ø§ÙˆØ² Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø£ØµÙ„ÙŠ'); return; }
        if (!reason) { alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø³Ø¨Ø¨ Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯'); return; }

        if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªØ±Ø¯Ø§Ø¯ ${formatCurrency(amount)}ØŸ`)) return;

        try {
            const result = await API.admin.refundPayment(selectedPayment.id, amount, reason + (notes ? ': ' + notes : ''));
            if (result.success) {
                alert('ØªÙ… Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­');
                closeRefundModal();
                loadPayments(currentPage, currentFilters);
            } else {
                alert(result.data?.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯');
            }
        } catch (error) {
            alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªØ±Ø¯Ø§Ø¯');
        }
    }

    async function queryGateway(tranRef) {
        try {
            const result = await API.admin.queryPaymentStatus(tranRef);
            if (result.success) {
                const data = result.data?.data || {};
                alert(`Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙˆØ§Ø¨Ø©: ${data.payment_status || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}\nØ§Ù„Ù…Ø¨Ù„Øº: ${data.cart_amount || '-'}\nØ§Ù„Ø±Ø¯: ${data.payment_result?.response_message || '-'}`);
            } else {
                alert(result.data?.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…');
            }
        } catch (error) {
            alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…');
        }
    }

    function getPaymentMethodLabel(method) {
        const labels = {
            'creditcard': 'Ø¨Ø·Ø§Ù‚Ø© Ø§Ø¦ØªÙ…Ø§Ù†',
            'mada': 'Ù…Ø¯Ù‰',
            'applepay': 'Apple Pay',
            'stcpay': 'STC Pay',
            'cash': 'Ù†Ù‚Ø¯ÙŠ',
            'bank_transfer': 'ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ'
        };
        return labels[method] || method || '-';
    }

    function getPaymentStatusLabel(status) {
        const labels = { 'pending': 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±', 'completed': 'Ù…ÙƒØªÙ…Ù„Ø©', 'failed': 'ÙØ§Ø´Ù„Ø©', 'refunded': 'Ù…Ø³ØªØ±Ø¯Ø©', 'cancelled': 'Ù…Ù„ØºÙŠØ©' };
        return labels[status] || status;
    }

    function getPaymentStatusBadgeClass(status) {
        const classes = { 'pending': 'badge-warning', 'completed': 'badge-success', 'failed': 'badge-danger', 'refunded': 'badge-info', 'cancelled': 'badge-gray' };
        return classes[status] || 'badge-gray';
    }

    function exportPayments() {
        if (currentPayments.length === 0) { alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª'); return; }
        const data = currentPayments.map(p => ({
            'Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹': p.reference_number, 'Ø§Ù„Ø¹Ù…ÙŠÙ„': p.customer?.full_name_ar,
            'Ø§Ù„Ù…Ø¨Ù„Øº': p.amount, 'Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹': getPaymentMethodLabel(p.payment_method),
            'Ø§Ù„ØªØ§Ø±ÙŠØ®': p.created_at, 'Ø§Ù„Ø­Ø§Ù„Ø©': getPaymentStatusLabel(p.status)
        }));
        exportToExcel(data, 'payments');
    }

    document.addEventListener('DOMContentLoaded', () => loadPayments());
</script>
{% endblock %}
