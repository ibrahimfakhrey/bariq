{% extends "admin/layout.html" %}

{% block title %}Ø§Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ³ÙˆÙŠØ§Øª{% endblock %}

{% block page_content %}
<div id="settlements-content">
    <div class="loading-container"><div class="spinner"></div></div>
</div>

<!-- Settlement Detail Modal -->
<div id="settlementModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
            <h3 id="modalTitle">ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ³ÙˆÙŠØ©</h3>
            <button onclick="closeModal()" class="btn btn-sm btn-secondary">&times;</button>
        </div>
        <div id="modalBody" class="modal-body"></div>
    </div>
</div>

<!-- Transfer Modal -->
<div id="transferModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h3>ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ­ÙˆÙŠÙ„</h3>
            <button onclick="closeTransferModal()" class="btn btn-sm btn-secondary">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Ø±Ù‚Ù… Ø§Ù„ØªØ³ÙˆÙŠØ©</label>
                <input type="text" id="transferSettlementRef" class="form-control" readonly>
            </div>
            <div class="form-group">
                <label>Ø§Ù„ØªØ§Ø¬Ø±</label>
                <input type="text" id="transferMerchant" class="form-control" readonly>
            </div>
            <div class="form-group">
                <label>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ØµØ§ÙÙŠ</label>
                <input type="text" id="transferAmount" class="form-control" readonly>
            </div>
            <div class="form-group">
                <label>Ø±Ù‚Ù… Ù…Ø±Ø¬Ø¹ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨Ù†ÙƒÙŠ <span style="color: var(--rose-500);">*</span></label>
                <input type="text" id="transferReference" class="form-control" placeholder="Ù…Ø«Ø§Ù„: TRF2026010400123" required>
            </div>
            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                <button onclick="closeTransferModal()" class="btn btn-secondary">Ø§Ù„ØºØ§Ø¡</button>
                <button onclick="confirmTransfer()" class="btn btn-primary">ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ­ÙˆÙŠÙ„</button>
            </div>
        </div>
    </div>
</div>

<style>
.modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; }
.modal-content { background: white; border-radius: 0.75rem; width: 90%; max-height: 90vh; overflow-y: auto; }
.modal-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.5rem; border-bottom: 1px solid var(--gray-200); }
.modal-header h3 { margin: 0; font-size: 1.125rem; }
.modal-body { padding: 1.5rem; }
.form-group { margin-bottom: 1rem; }
.form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--gray-700); }
.form-control { width: 100%; padding: 0.5rem 0.75rem; border: 1px solid var(--gray-300); border-radius: 0.375rem; font-size: 0.875rem; }
</style>
{% endblock %}

{% block extra_js %}
{{ super() }}
<script>
    let currentSettlements = [];
    let currentPage = 1;
    let currentFilters = {};
    let selectedSettlement = null;

    async function loadSettlements(page = 1, filters = {}) {
        const container = document.getElementById('settlements-content');
        currentPage = page;
        currentFilters = filters;

        try {
            const params = { page, per_page: 20, ...filters };
            const result = await API.admin.getSettlements(params);

            if (!result.success) {
                showError(container, 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ³ÙˆÙŠØ§Øª');
                return;
            }

            currentSettlements = result.data?.data?.settlements || [];
            const pagination = result.data?.data?.pagination || {};
            const summary = result.data?.data?.summary || {};

            container.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <div>
                        <h1 style="font-size: 1.5rem; font-weight: 700; color: var(--gray-900); margin-bottom: 0.25rem;">Ø§Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ³ÙˆÙŠØ§Øª</h1>
                        <p style="color: var(--gray-500);">Ø§Ø¬Ù…Ø§Ù„ÙŠ ${pagination.total || 0} ØªØ³ÙˆÙŠØ©</p>
                    </div>
                    <button onclick="exportSettlements()" class="btn btn-secondary">ğŸ“¥ ØªØµØ¯ÙŠØ± Excel</button>
                </div>

                <!-- Summary Cards -->
                <div class="grid-4" style="margin-bottom: 1.5rem;">
                    <div class="stat-card stat-card-amber">
                        <div class="stat-icon">â³</div>
                        <div class="stat-label">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©</div>
                        <div class="stat-value">${summary.pending_count || 0}</div>
                    </div>
                    <div class="stat-card stat-card-teal">
                        <div class="stat-icon">âœ…</div>
                        <div class="stat-label">Ù…Ø¹ØªÙ…Ø¯Ø©</div>
                        <div class="stat-value">${summary.approved_count || 0}</div>
                    </div>
                    <div class="stat-card stat-card-emerald">
                        <div class="stat-icon">ğŸ’¸</div>
                        <div class="stat-label">Ù…Ø­ÙˆÙ„Ø©</div>
                        <div class="stat-value">${summary.transferred_count || 0}</div>
                    </div>
                    <div class="stat-card stat-card-sky">
                        <div class="stat-icon">ğŸ’°</div>
                        <div class="stat-label">Ø§Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ø§Ù„Øº</div>
                        <div class="stat-value">${formatCurrency(summary.total_amount || 0)}</div>
                    </div>
                </div>

                <div class="card" style="margin-bottom: 1.5rem;">
                    <div style="display: flex; flex-wrap: wrap; gap: 1rem; align-items: flex-end;">
                        <div style="min-width: 200px;">
                            <label style="display: block; margin-bottom: 0.5rem; font-size: 0.875rem; color: var(--gray-600);">Ø§Ù„ØªØ§Ø¬Ø±</label>
                            <input type="text" id="merchantSearch" placeholder="Ø§Ø³Ù… Ø§Ù„ØªØ§Ø¬Ø±..." class="form-control" value="${filters.merchant_search || ''}" onkeyup="if(event.key === 'Enter') applyFilters()">
                        </div>
                        <div style="min-width: 150px;">
                            <label style="display: block; margin-bottom: 0.5rem; font-size: 0.875rem; color: var(--gray-600);">Ø§Ù„Ø­Ø§Ù„Ø©</label>
                            <select id="statusFilter" class="form-control" onchange="applyFilters()">
                                <option value="">Ø§Ù„ÙƒÙ„</option>
                                <option value="pending" ${filters.status === 'pending' ? 'selected' : ''}>Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©</option>
                                <option value="approved" ${filters.status === 'approved' ? 'selected' : ''}>Ù…Ø¹ØªÙ…Ø¯Ø©</option>
                                <option value="transferred" ${filters.status === 'transferred' ? 'selected' : ''}>Ù…Ø­ÙˆÙ„Ø©</option>
                                <option value="rejected" ${filters.status === 'rejected' ? 'selected' : ''}>Ù…Ø±ÙÙˆØ¶Ø©</option>
                            </select>
                        </div>
                        <div style="min-width: 150px;">
                            <label style="display: block; margin-bottom: 0.5rem; font-size: 0.875rem; color: var(--gray-600);">Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
                            <input type="date" id="fromDate" class="form-control" value="${filters.from_date || ''}">
                        </div>
                        <div style="min-width: 150px;">
                            <label style="display: block; margin-bottom: 0.5rem; font-size: 0.875rem; color: var(--gray-600);">Ø§Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
                            <input type="date" id="toDate" class="form-control" value="${filters.to_date || ''}">
                        </div>
                        <button onclick="applyFilters()" class="btn btn-primary">Ø¨Ø­Ø«</button>
                        <button onclick="clearFilters()" class="btn btn-secondary">Ù…Ø³Ø­</button>
                    </div>
                </div>

                <div class="card">
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹</th>
                                    <th>Ø§Ù„ØªØ§Ø¬Ø±</th>
                                    <th>Ø§Ù„ÙØªØ±Ø©</th>
                                    <th>Ø§Ù„Ø§Ø¬Ù…Ø§Ù„ÙŠ</th>
                                    <th>Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©</th>
                                    <th>Ø§Ù„ØµØ§ÙÙŠ</th>
                                    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                    <th>Ø§Ù„Ø§Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${currentSettlements.map(s => `
                                    <tr style="${s.status === 'pending' ? 'background: var(--amber-50);' : ''}">
                                        <td style="font-family: monospace; font-weight: 600;">${s.reference_number || '-'}</td>
                                        <td>${s.merchant?.name_ar || '-'}</td>
                                        <td>${formatDate(s.period_start)} - ${formatDate(s.period_end)}</td>
                                        <td>${formatCurrency(s.gross_amount)}</td>
                                        <td style="color: var(--rose-600);">-${formatCurrency(s.commission_amount)}</td>
                                        <td style="font-weight: 600; color: var(--teal-600);">${formatCurrency(s.net_amount)}</td>
                                        <td><span class="badge ${getSettlementStatusBadgeClass(s.status)}">${getSettlementStatusLabel(s.status)}</span></td>
                                        <td>
                                            <div style="display: flex; gap: 0.5rem;">
                                                <button onclick="viewSettlement('${s.id}')" class="btn btn-sm btn-secondary" title="Ø¹Ø±Ø¶">ğŸ‘ï¸</button>
                                                ${s.status === 'pending' ? `
                                                    <button onclick="approveSettlement('${s.id}')" class="btn btn-sm btn-primary" title="Ù…ÙˆØ§ÙÙ‚Ø©">âœ…</button>
                                                    <button onclick="rejectSettlement('${s.id}')" class="btn btn-sm" style="background: var(--rose-500); color: white;" title="Ø±ÙØ¶">âŒ</button>
                                                ` : ''}
                                                ${s.status === 'approved' ? `
                                                    <button onclick="openTransferModal('${s.id}')" class="btn btn-sm" style="background: var(--emerald-500); color: white;" title="ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ­ÙˆÙŠÙ„">ğŸ’¸</button>
                                                ` : ''}
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                                ${currentSettlements.length === 0 ? '<tr><td colspan="8" style="text-align: center; padding: 2rem; color: var(--gray-500);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</td></tr>' : ''}
                            </tbody>
                        </table>
                    </div>
                    ${pagination.pages > 1 ? `
                        <div style="display: flex; justify-content: center; gap: 0.5rem; padding: 1rem; border-top: 1px solid var(--gray-200);">
                            ${currentPage > 1 ? `<button onclick="loadSettlements(${currentPage - 1}, currentFilters)" class="btn btn-sm btn-secondary">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>` : ''}
                            <span style="padding: 0.5rem 1rem; color: var(--gray-600);">ØµÙØ­Ø© ${currentPage} Ù…Ù† ${pagination.pages}</span>
                            ${currentPage < pagination.pages ? `<button onclick="loadSettlements(${currentPage + 1}, currentFilters)" class="btn btn-sm btn-secondary">Ø§Ù„ØªØ§Ù„ÙŠ</button>` : ''}
                        </div>
                    ` : ''}
                </div>
            `;
        } catch (error) {
            showError(container, 'Ø­Ø¯Ø« Ø®Ø·Ø£');
        }
    }

    function applyFilters() {
        const filters = {
            merchant_search: document.getElementById('merchantSearch')?.value || '',
            status: document.getElementById('statusFilter')?.value || '',
            from_date: document.getElementById('fromDate')?.value || '',
            to_date: document.getElementById('toDate')?.value || ''
        };
        Object.keys(filters).forEach(k => !filters[k] && delete filters[k]);
        loadSettlements(1, filters);
    }

    function clearFilters() { loadSettlements(1, {}); }

    async function viewSettlement(id) {
        const modal = document.getElementById('settlementModal');
        const modalBody = document.getElementById('modalBody');
        modal.style.display = 'flex';
        modalBody.innerHTML = '<div class="loading-container"><div class="spinner"></div></div>';

        try {
            const result = await API.admin.getSettlement(id);
            const s = result.data?.data || {};
            const transactions = s.transactions || [];
            document.getElementById('modalTitle').textContent = `ØªØ³ÙˆÙŠØ© #${s.reference_number || ''}`;

            modalBody.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div><label style="color: var(--gray-500); font-size: 0.75rem;">Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹</label><div style="font-family: monospace;">${s.reference_number || '-'}</div></div>
                    <div><label style="color: var(--gray-500); font-size: 0.75rem;">Ø§Ù„Ø­Ø§Ù„Ø©</label><div><span class="badge ${getSettlementStatusBadgeClass(s.status)}">${getSettlementStatusLabel(s.status)}</span></div></div>
                    <div><label style="color: var(--gray-500); font-size: 0.75rem;">Ø§Ù„ØªØ§Ø¬Ø±</label><div>${s.merchant?.name_ar || '-'}</div></div>
                    <div><label style="color: var(--gray-500); font-size: 0.75rem;">ÙØªØ±Ø© Ø§Ù„ØªØ³ÙˆÙŠØ©</label><div>${formatDate(s.period_start)} - ${formatDate(s.period_end)}</div></div>
                </div>

                <hr style="margin: 1.5rem 0; border: none; border-top: 1px solid var(--gray-200);">
                <h4 style="margin-bottom: 1rem;">Ù…Ù„Ø®Øµ Ø§Ù„ØªØ³ÙˆÙŠØ©</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; text-align: center;">
                    <div style="background: var(--gray-50); padding: 1rem; border-radius: 0.5rem;">
                        <div style="color: var(--gray-500); font-size: 0.75rem;">Ø§Ù„Ø§Ø¬Ù…Ø§Ù„ÙŠ</div>
                        <div style="font-size: 1.25rem; font-weight: 700;">${formatCurrency(s.gross_amount)}</div>
                    </div>
                    <div style="background: var(--rose-50); padding: 1rem; border-radius: 0.5rem;">
                        <div style="color: var(--gray-500); font-size: 0.75rem;">Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© (${s.commission_rate || 0}%)</div>
                        <div style="font-size: 1.25rem; font-weight: 700; color: var(--rose-600);">-${formatCurrency(s.commission_amount)}</div>
                    </div>
                    <div style="background: var(--emerald-50); padding: 1rem; border-radius: 0.5rem;">
                        <div style="color: var(--gray-500); font-size: 0.75rem;">Ø§Ù„ØµØ§ÙÙŠ</div>
                        <div style="font-size: 1.25rem; font-weight: 700; color: var(--emerald-600);">${formatCurrency(s.net_amount)}</div>
                    </div>
                </div>

                ${s.transfer_reference ? `
                    <hr style="margin: 1.5rem 0; border: none; border-top: 1px solid var(--gray-200);">
                    <h4 style="margin-bottom: 1rem;">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ­ÙˆÙŠÙ„</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div><label style="color: var(--gray-500); font-size: 0.75rem;">Ù…Ø±Ø¬Ø¹ Ø§Ù„ØªØ­ÙˆÙŠÙ„</label><div style="font-family: monospace;">${s.transfer_reference}</div></div>
                        <div><label style="color: var(--gray-500); font-size: 0.75rem;">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ­ÙˆÙŠÙ„</label><div>${formatDateTime(s.transferred_at)}</div></div>
                    </div>
                ` : ''}

                ${transactions.length > 0 ? `
                    <hr style="margin: 1.5rem 0; border: none; border-top: 1px solid var(--gray-200);">
                    <h4 style="margin-bottom: 1rem;">Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ù…Ø´Ù…ÙˆÙ„Ø© (${transactions.length})</h4>
                    <div style="max-height: 200px; overflow-y: auto;">
                        <table class="table" style="font-size: 0.75rem;">
                            <thead><tr><th>Ø§Ù„Ù…Ø±Ø¬Ø¹</th><th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th></tr></thead>
                            <tbody>
                                ${transactions.map(t => `
                                    <tr>
                                        <td style="font-family: monospace;">${t.reference_number || '-'}</td>
                                        <td>${t.customer?.bariq_id || '-'}</td>
                                        <td>${formatCurrency(t.total_amount)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                ` : ''}

                <div style="margin-top: 1.5rem; display: flex; gap: 1rem; justify-content: flex-end;">
                    <button onclick="closeModal()" class="btn btn-secondary">Ø§ØºÙ„Ø§Ù‚</button>
                    ${s.status === 'pending' ? `
                        <button onclick="closeModal(); approveSettlement('${s.id}')" class="btn btn-primary">Ù…ÙˆØ§ÙÙ‚Ø©</button>
                    ` : ''}
                    ${s.status === 'approved' ? `
                        <button onclick="closeModal(); openTransferModal('${s.id}')" class="btn" style="background: var(--emerald-500); color: white;">ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ­ÙˆÙŠÙ„</button>
                    ` : ''}
                </div>
            `;
        } catch (error) {
            modalBody.innerHTML = '<div class="alert alert-error">Ø­Ø¯Ø« Ø®Ø·Ø£</div>';
        }
    }

    function closeModal() { document.getElementById('settlementModal').style.display = 'none'; }

    async function approveSettlement(id) {
        if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„ØªØ³ÙˆÙŠØ©ØŸ')) return;

        try {
            const result = await API.admin.approveSettlement(id);
            if (result.success) {
                alert('ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¨Ù†Ø¬Ø§Ø­');
                loadSettlements(currentPage, currentFilters);
            } else {
                alert(result.data?.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£');
            }
        } catch (error) {
            alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©');
        }
    }

    async function rejectSettlement(id) {
        const reason = prompt('Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶:');
        if (!reason) return;

        try {
            const result = await API.admin.rejectSettlement(id, reason);
            if (result.success) {
                alert('ØªÙ… Ø§Ù„Ø±ÙØ¶');
                loadSettlements(currentPage, currentFilters);
            } else {
                alert(result.data?.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£');
            }
        } catch (error) {
            alert('Ø­Ø¯Ø« Ø®Ø·Ø£');
        }
    }

    function openTransferModal(settlementId) {
        selectedSettlement = currentSettlements.find(s => s.id === settlementId);
        if (!selectedSettlement) return;

        document.getElementById('transferSettlementRef').value = selectedSettlement.reference_number;
        document.getElementById('transferMerchant').value = selectedSettlement.merchant?.name_ar || '';
        document.getElementById('transferAmount').value = formatCurrency(selectedSettlement.net_amount);
        document.getElementById('transferReference').value = '';
        document.getElementById('transferModal').style.display = 'flex';
    }

    function closeTransferModal() {
        document.getElementById('transferModal').style.display = 'none';
        selectedSettlement = null;
    }

    async function confirmTransfer() {
        if (!selectedSettlement) return;

        const transferReference = document.getElementById('transferReference').value.trim();
        if (!transferReference) { alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ù…Ø±Ø¬Ø¹ Ø§Ù„ØªØ­ÙˆÙŠÙ„'); return; }

        try {
            const result = await API.admin.transferSettlement(selectedSettlement.id, transferReference);
            if (result.success) {
                alert('ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­');
                closeTransferModal();
                loadSettlements(currentPage, currentFilters);
            } else {
                alert(result.data?.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£');
            }
        } catch (error) {
            alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ­ÙˆÙŠÙ„');
        }
    }

    function getSettlementStatusLabel(status) {
        const labels = { 'pending': 'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©', 'approved': 'Ù…Ø¹ØªÙ…Ø¯Ø©', 'transferred': 'Ù…Ø­ÙˆÙ„Ø©', 'rejected': 'Ù…Ø±ÙÙˆØ¶Ø©' };
        return labels[status] || status;
    }

    function getSettlementStatusBadgeClass(status) {
        const classes = { 'pending': 'badge-warning', 'approved': 'badge-info', 'transferred': 'badge-success', 'rejected': 'badge-danger' };
        return classes[status] || 'badge-gray';
    }

    function exportSettlements() {
        if (currentSettlements.length === 0) { alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª'); return; }
        const data = currentSettlements.map(s => ({
            'Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹': s.reference_number, 'Ø§Ù„ØªØ§Ø¬Ø±': s.merchant?.name_ar,
            'Ø§Ù„ÙØªØ±Ø© Ù…Ù†': s.period_start, 'Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù‰': s.period_end,
            'Ø§Ù„Ø§Ø¬Ù…Ø§Ù„ÙŠ': s.gross_amount, 'Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©': s.commission_amount, 'Ø§Ù„ØµØ§ÙÙŠ': s.net_amount,
            'Ø§Ù„Ø­Ø§Ù„Ø©': getSettlementStatusLabel(s.status)
        }));
        exportToExcel(data, 'settlements');
    }

    document.addEventListener('DOMContentLoaded', () => loadSettlements());
</script>
{% endblock %}
