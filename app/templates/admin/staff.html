{% extends "admin/layout.html" %}

{% block title %}Ø§Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†{% endblock %}

{% block page_content %}
<div id="staff-content">
    <div class="loading-container"><div class="spinner"></div></div>
</div>

<!-- Staff Modal -->
<div id="staffModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h3 id="modalTitle">Ø§Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù</h3>
            <button onclick="closeModal()" class="btn btn-sm btn-secondary">&times;</button>
        </div>
        <div id="modalBody" class="modal-body">
            <form id="staffForm" onsubmit="saveStaff(event)">
                <input type="hidden" id="staffId">
                <div class="form-group">
                    <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ <span style="color: var(--rose-500);">*</span></label>
                    <input type="text" id="staffName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø§Ù„ÙƒØªØ±ÙˆÙ†ÙŠ <span style="color: var(--rose-500);">*</span></label>
                    <input type="email" id="staffEmail" class="form-control" required>
                </div>
                <div class="form-group" id="passwordGroup">
                    <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± <span style="color: var(--rose-500);">*</span></label>
                    <input type="password" id="staffPassword" class="form-control" minlength="8">
                    <small style="color: var(--gray-500);">8 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„</small>
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ø¯ÙˆØ± <span style="color: var(--rose-500);">*</span></label>
                    <select id="staffRole" class="form-control" required>
                        <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙˆØ± --</option>
                        <option value="super_admin">Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…</option>
                        <option value="accountant">Ù…Ø­Ø§Ø³Ø¨</option>
                        <option value="sales">Ù…Ø¨ÙŠØ¹Ø§Øª</option>
                        <option value="support">Ø¯Ø¹Ù… ÙÙ†ÙŠ</option>
                        <option value="collections">ØªØ­ØµÙŠÙ„</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ù‚Ø³Ù…</label>
                    <input type="text" id="staffDepartment" class="form-control" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ù…Ø§Ù„ÙŠØ©">
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ø­Ø§Ù„Ø©</label>
                    <select id="staffStatus" class="form-control">
                        <option value="active">Ù†Ø´Ø·</option>
                        <option value="inactive">ØºÙŠØ± Ù†Ø´Ø·</option>
                    </select>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                    <button type="button" onclick="closeModal()" class="btn btn-secondary">Ø§Ù„ØºØ§Ø¡</button>
                    <button type="submit" class="btn btn-primary">Ø­ÙØ¸</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; }
.modal-content { background: white; border-radius: 0.75rem; width: 90%; max-height: 90vh; overflow-y: auto; }
.modal-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.5rem; border-bottom: 1px solid var(--gray-200); }
.modal-header h3 { margin: 0; font-size: 1.125rem; }
.modal-body { padding: 1.5rem; }
.form-group { margin-bottom: 1rem; }
.form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--gray-700); }
.form-control { width: 100%; padding: 0.5rem 0.75rem; border: 1px solid var(--gray-300); border-radius: 0.375rem; font-size: 0.875rem; }
</style>
{% endblock %}

{% block extra_js %}
{{ super() }}
<script>
    let currentStaff = [];
    let editingStaff = null;

    async function loadStaff() {
        const container = document.getElementById('staff-content');

        try {
            const result = await API.admin.getStaff();

            if (!result.success) {
                showError(container, 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†');
                return;
            }

            currentStaff = result.data?.data?.staff || result.data?.data || [];

            container.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <div>
                        <h1 style="font-size: 1.5rem; font-weight: 700; color: var(--gray-900); margin-bottom: 0.25rem;">Ø§Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h1>
                        <p style="color: var(--gray-500);">Ø§Ø¬Ù…Ø§Ù„ÙŠ ${currentStaff.length} Ù…ÙˆØ¸Ù</p>
                    </div>
                    <button onclick="openAddModal()" class="btn btn-primary">+ Ø§Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù</button>
                </div>

                <!-- Role Stats -->
                <div class="grid-4" style="margin-bottom: 1.5rem;">
                    <div class="stat-card stat-card-teal">
                        <div class="stat-icon">ğŸ‘¤</div>
                        <div class="stat-label">Ù…Ø¯ÙŠØ±ÙŠÙ†</div>
                        <div class="stat-value">${currentStaff.filter(s => s.role === 'super_admin').length}</div>
                    </div>
                    <div class="stat-card stat-card-emerald">
                        <div class="stat-icon">ğŸ’¼</div>
                        <div class="stat-label">Ù…Ø­Ø§Ø³Ø¨ÙŠÙ†</div>
                        <div class="stat-value">${currentStaff.filter(s => s.role === 'accountant').length}</div>
                    </div>
                    <div class="stat-card stat-card-sky">
                        <div class="stat-icon">ğŸ“</div>
                        <div class="stat-label">Ø¯Ø¹Ù… ÙÙ†ÙŠ</div>
                        <div class="stat-value">${currentStaff.filter(s => s.role === 'support').length}</div>
                    </div>
                    <div class="stat-card stat-card-amber">
                        <div class="stat-icon">ğŸ’°</div>
                        <div class="stat-label">ØªØ­ØµÙŠÙ„</div>
                        <div class="stat-value">${currentStaff.filter(s => s.role === 'collections').length}</div>
                    </div>
                </div>

                <div class="card">
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Ø§Ù„Ø§Ø³Ù…</th>
                                    <th>Ø§Ù„Ø¨Ø±ÙŠØ¯</th>
                                    <th>Ø§Ù„Ø¯ÙˆØ±</th>
                                    <th>Ø§Ù„Ù‚Ø³Ù…</th>
                                    <th>Ø¢Ø®Ø± Ø¯Ø®ÙˆÙ„</th>
                                    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                    <th>Ø§Ù„Ø§Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${currentStaff.map(s => `
                                    <tr>
                                        <td><strong>${s.full_name || s.name || '-'}</strong></td>
                                        <td>${s.email || '-'}</td>
                                        <td><span class="badge ${getRoleBadgeClass(s.role)}">${getRoleLabel(s.role)}</span></td>
                                        <td>${s.department || '-'}</td>
                                        <td>${formatDateTime(s.last_login_at)}</td>
                                        <td><span class="badge ${s.status === 'active' ? 'badge-success' : 'badge-gray'}">${s.status === 'active' ? 'Ù†Ø´Ø·' : 'ØºÙŠØ± Ù†Ø´Ø·'}</span></td>
                                        <td>
                                            <div style="display: flex; gap: 0.5rem;">
                                                <button onclick="editStaff('${s.id}')" class="btn btn-sm btn-secondary" title="ØªØ¹Ø¯ÙŠÙ„">âœï¸</button>
                                                ${s.status === 'active' ? `
                                                    <button onclick="deactivateStaff('${s.id}')" class="btn btn-sm" style="background: var(--amber-500); color: white;" title="ØªØ¹Ø·ÙŠÙ„">â¸ï¸</button>
                                                ` : `
                                                    <button onclick="activateStaff('${s.id}')" class="btn btn-sm" style="background: var(--emerald-500); color: white;" title="ØªÙØ¹ÙŠÙ„">â–¶ï¸</button>
                                                `}
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                                ${currentStaff.length === 0 ? '<tr><td colspan="7" style="text-align: center; padding: 2rem; color: var(--gray-500);">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¸ÙÙŠÙ†</td></tr>' : ''}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        } catch (error) {
            showError(container, 'Ø­Ø¯Ø« Ø®Ø·Ø£');
        }
    }

    function openAddModal() {
        editingStaff = null;
        document.getElementById('modalTitle').textContent = 'Ø§Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù';
        document.getElementById('staffForm').reset();
        document.getElementById('staffId').value = '';
        document.getElementById('passwordGroup').style.display = 'block';
        document.getElementById('staffPassword').required = true;
        document.getElementById('staffModal').style.display = 'flex';
    }

    function editStaff(id) {
        const staff = currentStaff.find(s => s.id === id);
        if (!staff) return;

        editingStaff = staff;
        document.getElementById('modalTitle').textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ù…ÙˆØ¸Ù';
        document.getElementById('staffId').value = staff.id;
        document.getElementById('staffName').value = staff.full_name || staff.name || '';
        document.getElementById('staffEmail').value = staff.email || '';
        document.getElementById('staffRole').value = staff.role || '';
        document.getElementById('staffDepartment').value = staff.department || '';
        document.getElementById('staffStatus').value = staff.status || 'active';

        // Hide password field for edit
        document.getElementById('passwordGroup').style.display = 'none';
        document.getElementById('staffPassword').required = false;

        document.getElementById('staffModal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('staffModal').style.display = 'none';
        editingStaff = null;
    }

    async function saveStaff(event) {
        event.preventDefault();

        const id = document.getElementById('staffId').value;
        const data = {
            full_name: document.getElementById('staffName').value,
            email: document.getElementById('staffEmail').value,
            role: document.getElementById('staffRole').value,
            department: document.getElementById('staffDepartment').value,
            status: document.getElementById('staffStatus').value
        };

        if (!id) {
            // New staff - include password
            data.password = document.getElementById('staffPassword').value;
            if (!data.password || data.password.length < 8) {
                alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 8 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
                return;
            }
        }

        try {
            let result;
            if (id) {
                result = await API.admin.updateStaff(id, data);
            } else {
                result = await API.admin.createStaff(data);
            }

            if (result.success) {
                alert(id ? 'ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ù†Ø¬Ø§Ø­' : 'ØªÙ…Øª Ø§Ù„Ø§Ø¶Ø§ÙØ© Ø¨Ù†Ø¬Ø§Ø­');
                closeModal();
                loadStaff();
            } else {
                alert(result.data?.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£');
            }
        } catch (error) {
            alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸');
        }
    }

    async function deactivateStaff(id) {
        if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ¹Ø·ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¸ÙØŸ')) return;

        try {
            const result = await API.admin.updateStaff(id, { status: 'inactive' });
            if (result.success) {
                alert('ØªÙ… Ø§Ù„ØªØ¹Ø·ÙŠÙ„');
                loadStaff();
            } else {
                alert(result.data?.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£');
            }
        } catch (error) {
            alert('Ø­Ø¯Ø« Ø®Ø·Ø£');
        }
    }

    async function activateStaff(id) {
        if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªÙØ¹ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¸ÙØŸ')) return;

        try {
            const result = await API.admin.updateStaff(id, { status: 'active' });
            if (result.success) {
                alert('ØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„');
                loadStaff();
            } else {
                alert(result.data?.message || 'Ø­Ø¯Ø« Ø®Ø·Ø£');
            }
        } catch (error) {
            alert('Ø­Ø¯Ø« Ø®Ø·Ø£');
        }
    }

    function getRoleLabel(role) {
        const labels = {
            'super_admin': 'Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…',
            'accountant': 'Ù…Ø­Ø§Ø³Ø¨',
            'sales': 'Ù…Ø¨ÙŠØ¹Ø§Øª',
            'support': 'Ø¯Ø¹Ù… ÙÙ†ÙŠ',
            'collections': 'ØªØ­ØµÙŠÙ„'
        };
        return labels[role] || role || '-';
    }

    function getRoleBadgeClass(role) {
        const classes = {
            'super_admin': 'badge-danger',
            'accountant': 'badge-info',
            'sales': 'badge-success',
            'support': 'badge-warning',
            'collections': 'badge-gray'
        };
        return classes[role] || 'badge-gray';
    }

    document.addEventListener('DOMContentLoaded', loadStaff);
</script>
{% endblock %}
