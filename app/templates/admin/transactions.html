{% extends "admin/layout.html" %}

{% block title %}Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª{% endblock %}

{% block page_content %}
<div id="transactions-content">
    <div class="loading-container"><div class="spinner"></div></div>
</div>

<style>
.form-control { width: 100%; padding: 0.5rem 0.75rem; border: 1px solid var(--gray-300); border-radius: 0.375rem; font-size: 0.875rem; }
</style>
{% endblock %}

{% block extra_js %}
{{ super() }}
<script>
    let currentTransactions = [];
    let currentPage = 1;
    let currentFilters = {};

    async function loadTransactions(page = 1, filters = {}) {
        const container = document.getElementById('transactions-content');
        currentPage = page;
        currentFilters = filters;

        try {
            const params = { page, per_page: 20, ...filters };
            const result = await API.admin.getTransactions(params);
            currentTransactions = result.data?.data?.transactions || [];
            const pagination = result.data?.data?.pagination || {};

            container.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <div>
                        <h1 style="font-size: 1.5rem; font-weight: 700; color: var(--gray-900); margin-bottom: 0.25rem;">Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª</h1>
                        <p style="color: var(--gray-500);">Ø§Ø¬Ù…Ø§Ù„ÙŠ ${pagination.total || 0} Ù…Ø¹Ø§Ù…Ù„Ø©</p>
                    </div>
                    <button onclick="exportTransactions()" class="btn btn-secondary">ğŸ“¥ ØªØµØ¯ÙŠØ± Excel</button>
                </div>

                <div class="card" style="margin-bottom: 1.5rem;">
                    <div style="display: flex; flex-wrap: wrap; gap: 1rem; align-items: flex-end;">
                        <div style="min-width: 150px;">
                            <label style="display: block; margin-bottom: 0.5rem; font-size: 0.875rem; color: var(--gray-600);">Ø§Ù„Ø­Ø§Ù„Ø©</label>
                            <select id="statusFilter" class="form-control" onchange="applyFilters()">
                                <option value="">Ø§Ù„ÙƒÙ„</option>
                                <option value="pending" ${filters.status === 'pending' ? 'selected' : ''}>Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯</option>
                                <option value="confirmed" ${filters.status === 'confirmed' ? 'selected' : ''}>Ù…Ø¤ÙƒØ¯Ø©</option>
                                <option value="paid" ${filters.status === 'paid' ? 'selected' : ''}>Ù…Ø¯ÙÙˆØ¹Ø©</option>
                                <option value="overdue" ${filters.status === 'overdue' ? 'selected' : ''}>Ù…ØªØ£Ø®Ø±Ø©</option>
                                <option value="cancelled" ${filters.status === 'cancelled' ? 'selected' : ''}>Ù…Ù„ØºÙŠØ©</option>
                            </select>
                        </div>
                        <div style="min-width: 150px;">
                            <label style="display: block; margin-bottom: 0.5rem; font-size: 0.875rem; color: var(--gray-600);">Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
                            <input type="date" id="fromDate" class="form-control" value="${filters.from_date || ''}">
                        </div>
                        <div style="min-width: 150px;">
                            <label style="display: block; margin-bottom: 0.5rem; font-size: 0.875rem; color: var(--gray-600);">Ø§Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
                            <input type="date" id="toDate" class="form-control" value="${filters.to_date || ''}">
                        </div>
                        <button onclick="applyFilters()" class="btn btn-primary">Ø¨Ø­Ø«</button>
                        <button onclick="clearFilters()" class="btn btn-secondary">Ù…Ø³Ø­</button>
                    </div>
                </div>

                <div class="card">
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ</th>
                                    <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                                    <th>Ø§Ù„ØªØ§Ø¬Ø±</th>
                                    <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                                    <th>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th>
                                    <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</th>
                                    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${currentTransactions.map(t => `
                                    <tr style="${t.status === 'overdue' ? 'background: var(--rose-50);' : ''}">
                                        <td style="font-family: monospace; font-weight: 600;">${t.reference_number || '-'}</td>
                                        <td>${t.customer?.full_name_ar || t.customer?.bariq_id || '-'}</td>
                                        <td>${t.merchant?.name_ar || '-'}</td>
                                        <td>${formatCurrency(t.total_amount)}</td>
                                        <td>${formatCurrency(t.paid_amount)}</td>
                                        <td>${formatDate(t.due_date)}</td>
                                        <td><span class="badge ${getStatusBadgeClass(t.status)}">${getStatusLabel(t.status)}</span></td>
                                    </tr>
                                `).join('')}
                                ${currentTransactions.length === 0 ? '<tr><td colspan="7" style="text-align: center; padding: 2rem; color: var(--gray-500);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</td></tr>' : ''}
                            </tbody>
                        </table>
                    </div>
                    ${pagination.pages > 1 ? `
                        <div style="display: flex; justify-content: center; gap: 0.5rem; padding: 1rem; border-top: 1px solid var(--gray-200);">
                            ${currentPage > 1 ? `<button onclick="loadTransactions(${currentPage - 1}, currentFilters)" class="btn btn-sm btn-secondary">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>` : ''}
                            <span style="padding: 0.5rem 1rem;">ØµÙØ­Ø© ${currentPage} Ù…Ù† ${pagination.pages}</span>
                            ${currentPage < pagination.pages ? `<button onclick="loadTransactions(${currentPage + 1}, currentFilters)" class="btn btn-sm btn-secondary">Ø§Ù„ØªØ§Ù„ÙŠ</button>` : ''}
                        </div>
                    ` : ''}
                </div>
            `;
        } catch (error) { showError(container, 'Ø­Ø¯Ø« Ø®Ø·Ø£'); }
    }

    function applyFilters() {
        const filters = {
            status: document.getElementById('statusFilter')?.value || '',
            from_date: document.getElementById('fromDate')?.value || '',
            to_date: document.getElementById('toDate')?.value || ''
        };
        Object.keys(filters).forEach(k => !filters[k] && delete filters[k]);
        loadTransactions(1, filters);
    }

    function clearFilters() { loadTransactions(1, {}); }

    function exportTransactions() {
        if (currentTransactions.length === 0) { alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª'); return; }
        const data = currentTransactions.map(t => ({
            'Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ': t.reference_number, 'Ø§Ù„Ø¹Ù…ÙŠÙ„': t.customer?.full_name_ar,
            'Ø§Ù„ØªØ§Ø¬Ø±': t.merchant?.name_ar, 'Ø§Ù„Ù…Ø¨Ù„Øº': t.total_amount, 'Ø§Ù„Ù…Ø¯ÙÙˆØ¹': t.paid_amount,
            'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚': t.due_date, 'Ø§Ù„Ø­Ø§Ù„Ø©': getStatusLabel(t.status)
        }));
        exportToExcel(data, 'transactions');
    }

    document.addEventListener('DOMContentLoaded', () => loadTransactions());
</script>
{% endblock %}
