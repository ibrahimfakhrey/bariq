{% extends "customer/layout.html" %}

{% block title %}Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª - Ø¨Ø±ÙŠÙ‚ Ø§Ù„ÙŠØ³Ø±{% endblock %}

{% block page_content %}
<div class="card mb-6">
    <div class="card-header">
        <h2 style="font-size: 1.5rem; margin: 0;">Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø§Øª</h2>
    </div>
    <div id="debt-summary">
        <div class="loading-container" style="min-height: 100px;">
            <div class="spinner"></div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h2 style="font-size: 1.5rem; margin: 0;">Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª</h2>
    </div>
    <div id="payments-content">
        <div class="loading-container">
            <div class="spinner"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ super() }}
<script>
    async function loadPaymentsPage() {
        const debtContainer = document.getElementById('debt-summary');
        const paymentsContainer = document.getElementById('payments-content');

        try {
            const [debtRes, paymentsRes] = await Promise.all([
                API.customer.getDebt(),
                API.customer.getPayments({ per_page: 50 }),
            ]);

            const debt = debtRes.data?.data || {};
            const payments = paymentsRes.data?.data?.payments || [];

            // Debt summary
            debtContainer.innerHTML = `
        <div class="grid grid-3">
          <div class="stat-card ${debt.overdue_amount > 0 ? '' : 'green'}" style="${debt.overdue_amount > 0 ? 'background: linear-gradient(135deg, #ef4444, #dc2626);' : ''}">
            <div class="stat-card-header">
              <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø§Øª</span>
            </div>
            <div class="stat-card-value">${formatNumber(debt.total_debt || 0)}</div>
            <div class="stat-card-label">Ù†Ù‚Ø·Ø©</div>
          </div>
          
          <div class="stat-card gold">
            <div class="stat-card-header">
              <span>Ù…Ø³ØªØ­Ù‚Ø§Øª Ù…ØªØ£Ø®Ø±Ø©</span>
            </div>
            <div class="stat-card-value">${formatNumber(debt.overdue_amount || 0)}</div>
            <div class="stat-card-label">Ù†Ù‚Ø·Ø©</div>
          </div>
          
          <div class="stat-card blue">
            <div class="stat-card-header">
              <span>Ù…Ø¹Ø§Ù…Ù„Ø§Øª ØºÙŠØ± Ù…Ø³Ø¯Ø¯Ø©</span>
            </div>
            <div class="stat-card-value">${debt.pending_transactions || 0}</div>
            <div class="stat-card-label">Ù…Ø¹Ø§Ù…Ù„Ø©</div>
          </div>
        </div>
      `;

            // Payments list
            if (payments.length === 0) {
                paymentsContainer.innerHTML = `
          <div class="text-center p-6 text-muted">
            <span style="font-size: 3rem;">ğŸ’°</span>
            <p class="mt-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</p>
          </div>
        `;
            } else {
                paymentsContainer.innerHTML = `
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                  <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                  <th>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</th>
                  <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                  <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
                </tr>
              </thead>
              <tbody>
                ${payments.map(payment => `
                  <tr>
                    <td>${formatDateTime(payment.payment_date)}</td>
                    <td class="font-bold">${formatNumber(payment.amount)} Ù†Ù‚Ø·Ø©</td>
                    <td>${payment.payment_method || '-'}</td>
                    <td><span class="badge ${getStatusBadgeClass(payment.status)}">${getStatusLabel(payment.status)}</span></td>
                    <td>
                      ${payment.status === 'pending' ? `
                        <button class="btn btn-sm btn-primary" onclick="verifyPayment('${payment.id}')" id="verify-btn-${payment.id}">
                          ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¯ÙØ¹
                        </button>
                      ` : '-'}
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `;
            }

        } catch (error) {
            console.error('Error loading payments:', error);
            showError(debtContainer, 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
        }
    }

    async function verifyPayment(paymentId) {
        const btn = document.getElementById(`verify-btn-${paymentId}`);
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...';

        try {
            const response = await fetch(`/api/v1/customers/me/payments/${paymentId}/verify`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                }
            });

            const result = await response.json();

            if (result.success) {
                if (result.data?.status === 'completed' || result.message?.includes('completed')) {
                    alert('ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¯ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­! Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.');
                    loadPaymentsPage();
                } else {
                    alert(result.message || 'Ø§Ù„Ø¯ÙØ¹Ø© Ù„Ø§ ØªØ²Ø§Ù„ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©');
                    btn.disabled = false;
                    btn.textContent = originalText;
                }
            } else {
                // Show Arabic error message if available
                const errorMsg = result.message || 'ÙØ´Ù„ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¯ÙØ¹';
                const details = result.details ? `\n\nØªÙØ§ØµÙŠÙ„: ${result.details}` : '';
                alert(errorMsg + details);
                btn.disabled = false;
                btn.textContent = originalText;
            }
        } catch (error) {
            console.error('Error verifying payment:', error);
            alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚');
            btn.disabled = false;
            btn.textContent = originalText;
        }
    }

    document.addEventListener('DOMContentLoaded', loadPaymentsPage);
</script>
{% endblock %}